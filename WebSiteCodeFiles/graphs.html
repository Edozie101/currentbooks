<HTML><HEAD><TITLE>graphs functions</TITLE></HEAD><BODY><H2 ALIGN="center">Functions for cast member "graphs" of castlib "math"</H2><P><PRE><KBD><A NAME="drawGraph"> </A>on drawGraph (functionsToDraw, params)<BR> --! ARGUMENTS: functionstodraw (a function or list of functions, which can <BR> --! be either strings or handler name symbols), params (a property list of parameters - see below)<BR> --! RETURNS: a property list including an image of the graph and various other information.<BR> --! params should be a property list with any or all of the following properties:<BR> --! #minX, #maxX: Minimum and maximum x-values to be plotted (default:from 0 to 100)<BR> --! #minY, #maxY: Minimum and maximum y-values to be plotted (default is to scale automatically)<BR> --! #res: Number of x-points to be plotted (evenly spaced; an odd number is best) (default:21)<BR> --! #col: Either a colour such as rgb(0,0,0) or a list of such colours (default: rgb(0,0,0))<BR> --! #pregraph: If the function is to be drawn onto an existing graph, <BR> --! then this should be a list with the relevant details (the output of a previous <BR> --! version of the function) (default is to make a new image)<BR> --! #w, #h: The width and height of the end image in pixels (default: 200)<BR> --! #labels: Boolean value - TRUE adds a label with the function (TRUE is default)<BR> <BR> bord=20<BR> <BR> -- set defaults<BR> if not listp(functionsToDraw) then functionsToDraw=&#091;functionsToDraw&#093;<BR> if not listp(params) then params=&#091;:&#093;<BR> else if ilk(params)&#060;&#062;#proplist then params=&#091;:&#093;<BR> <BR> if voidp(params&#091;#minx&#093;) then <BR> if voidp(params&#091;#maxx&#093;) then minx=0.0<BR> else minx=min(params.maxx-100.0,0)<BR> else if not integerp(params.minx) and not floatp(params.minx) then <BR> if voidp(params&#091;#maxx&#093;) then minx=0.0<BR> else minx=min(params.maxx-100.0,0)<BR> else<BR> minx=float(params.minx)<BR> end if<BR> <BR> if voidp(params&#091;#maxx&#093;) then maxx=minx+100<BR> else if not integerp(params.maxx) and not floatp(params.maxx) then maxx=minx+100<BR> else if params.maxx&#060;minx then <BR> maxx=minx<BR> minx=float(params.maxx)<BR> else if params.maxx=minx then <BR> maxx=minx+100<BR> else maxx=float(params.maxx)<BR> <BR> scaley=0<BR> if voidp(params&#091;#miny&#093;) or voidp(params&#091;#maxy&#093;) then scaley=1<BR> else <BR> if not integerp(params.miny) and not floatp(params.miny) then scaley=1<BR> if not integerp(params.maxy) and not floatp(params.maxy) then scaley=1<BR> miny=float(params.miny)<BR> maxy=float(params.maxy)<BR> if miny&#062;=maxy then scaley=1<BR> end if<BR> <BR> <BR> if voidp(params&#091;#res&#093;) then res=21<BR> else if not integerp(params.res) then res=21<BR> else if params.res&#060;2 then res=21<BR> else res=params.res<BR> <BR> newgraph=1<BR> <BR> if listp(params&#091;#pregraph&#093;) then <BR> -- draw onto an existing graph: calculate default<BR> -- values from the existing graph<BR> l=params.pregraph<BR> im=l&#091;#graph&#093;<BR> if objectp(im) then <BR> if ilk(im)=#image then<BR> w=im.width-2*bord<BR> h=im.height-2*bord<BR> leftx=params.pregraph&#091;#leftx&#093;<BR> rightx=params.pregraph&#091;#rightx&#093;<BR> if floatp(l.topy) and floatp(l.bottomy) and floatp(leftx) and floatp(rightx) then<BR> newgraph=0<BR> if minx&#060;leftx or maxx&#062;rightx then -- rescale graph<BR> im2=image(w,h,16)<BR> if minx&#060;leftx then lft=(maxx-minx)/ (leftx-minx)<BR> else lft=0<BR> if maxx&#062;rightx then rt=(maxx-minx)/ (maxx-rightx)<BR> else rt=0<BR> im2.copypixels(im,im2.rect+rect(bord+lft,bord,-bord-rt,-bord),\<BR>im.rect+rect(bord,bord,-bord,-bord))<BR> im=im2<BR> end if<BR> end if<BR> end if<BR> end if<BR> end if<BR> <BR> if newgraph then<BR> -- create a new image object and set width and height<BR> if voidp(params&#091;#w&#093;) then w=200<BR> else if not integerp(params.w) and not floatp(params.w) then w=200<BR> else w=params.w<BR> <BR> if voidp(params&#091;#h&#093;) then h=200<BR> else if not integerp(params.h) and not floatp(params.h) then h=200<BR> else h=params.h<BR> <BR> im=image(w+bord*2,h+bord*2,16)<BR> leftx=0<BR> rightx=0<BR> topy=0<BR> bottomy=0<BR> end if<BR> <BR> if voidp(params&#091;#col&#093;) then col=&#091;&#093;<BR> else if not listp(params.col) and ilk(params.col)&#060;&#062;#color then col=&#091;&#093;<BR> else col=params.col<BR> <BR> <BR> if not listp(col) then<BR> cl=&#091;&#093;<BR> repeat with i=1 to functionsToDraw.count<BR> cl.add(col)<BR> end repeat<BR> col=cl<BR> end if<BR> repeat while col.count&#060;functionsToDraw.count<BR> repeat with i=1 to 4<BR> col.add(&#091;rgb(255,0,0),rgb(255,0,255),rgb(0,100,0),rgb(0,0,255)&#093;&#091;i&#093;)<BR> end repeat<BR> end repeat<BR> <BR> if voidp(params&#091;#labels&#093;) then labels=1<BR> else if params.labels&#060;&#062;0 then labels=1<BR> else labels=params.labels<BR> <BR> -- create text member to copy text from<BR> textmem=new(#text)<BR> textmem.font="arial"<BR> textmem.fontsize=10<BR> textmem.width=100<BR> textmem.alignment=#center<BR> <BR> -- calculate values of the functions<BR> xValues=&#091;&#093;<BR> yValues=&#091;&#093;<BR> repeat with f in functionsToDraw<BR> spacing = (maxX - minX) / float(res - 1)<BR> -- spacing is the distance between consecutive x values<BR> repeat with i = 0 to (res - 1)<BR> x = minX + i * spacing<BR> <BR> y = <A HREF="algebra.html#calculateValue">calculateValue</A>(f,x)<BR> xValues.add(x)<BR> yValues.add(y)<BR> end repeat<BR> xValues.add("stop")<BR> yValues.add("stop")<BR> end repeat<BR> <BR> -- calculate the scale of the graph<BR> leftX = min(minX, leftx)<BR> rightX = max(maxX, rightx)<BR> -- leftX and rightX are the x-values at each end of the <BR> -- x-axis to be drawn<BR> xScale = w / (rightX - leftX)<BR> if scaley then <BR> maxy=<A HREF="graphs.html#highest">highest</A>(yValues)<BR> miny=<A HREF="graphs.html#lowest">lowest</A>(yvalues)<BR> end if<BR> <BR> topY = max(maxy, topy)<BR> bottomY = min(miny , bottomy)<BR> <BR> if not newgraph then<BR> if bottomy&#060;l.bottomy or topy&#062;l.topy then -- rescale graph<BR> im2=image(w,h,16)<BR> if bottomy&#060;l.bottomy then tp=(topy-bottomy)/ (l.bottomy-bottomy)<BR> else tp=0<BR> if topy&#062;l.topy then bt=(topy-bottomy)/ (topy-l.topy)<BR> else bt=0<BR> im2.copypixels(im,im2.rect+rect(bord,bord+tp,-bord,-bord-bt),\<BR>im.rect+rect(bord,bord,-bord,-bord))<BR> im=im2<BR> end if<BR> end if<BR> <BR> yScale = h / (topY - bottomY)<BR> <BR> if newgraph then<BR> -- draw axes<BR> x0 = xScale * (-leftX)<BR> y0 = yScale * (-bottomY)<BR> -- x0 and y0 are the positions within the graph of the axes<BR> -- add label at origin<BR> <A HREF="graphs.html#drawtext">drawtext</A>(im, "0", point(x0-5,y0-5), bord, textmem)<BR> -- draw y-axis<BR> <A HREF="graphs.html#drawline">drawline</A>(im,point(x0, 0), point(x0, h), bord)<BR> -- add arrow to top<BR> <A HREF="graphs.html#drawline">drawline</A>(im, point(x0,h), point(x0-5, h-7), bord)<BR> <A HREF="graphs.html#drawline">drawline</A>(im, point(x0,h), point(x0+5, h-7), bord)<BR> -- add label<BR> <A HREF="graphs.html#drawtext">drawtext</A>(im, "y", point(x0+5,h+5), bord, textmem)<BR> -- add scale<BR> -- calculate sensible increments<BR> mx=max(topY,abs(bottomY))<BR> lg=log(mx)/log(10)<BR> if integer(lg)&#062;lg then p=integer(lg)-1<BR> else p=integer(lg)<BR> n=mx/power(10,p)<BR> sc=power(10,p)<BR> if n&#060;2 then <BR> p=p-1<BR> sc=sc/10<BR> n=n*10<BR> else if n&#060;8 then<BR> p=p-1<BR> sc=sc/2<BR> n=n*2<BR> end if<BR> -- choose whether to alternate text labels<BR> if n&#062;8 then alt=0<BR> else alt=1<BR> -- write labels with sensible float precision<BR> the floatprecision=min(0,p)<BR> <BR> -- draw scale above origin<BR> y=sc<BR> d=0<BR> repeat while y&#060;=topY<BR> <A HREF="graphs.html#drawline">drawline</A>(im, point(x0-3, y0+y*yScale), point(x0, y0+y*yScale), bord)<BR> if d or alt then <A HREF="graphs.html#drawtext">drawtext</A>(im, string(y), point(x0-10, y0+y*yScale), bord, textmem)<BR> y=y+sc<BR> d=not d<BR> end repeat<BR> -- draw scale below origin<BR> y=-sc<BR> d=0<BR> repeat while y&#062;=bottomY<BR> <A HREF="graphs.html#drawline">drawline</A>(im, point(x0-3, y0+y*yScale), point(x0, y0+y*yScale), bord)<BR> if d or alt then <A HREF="graphs.html#drawtext">drawtext</A>(im, string(y), point(x0-10, y0+y*yScale), bord, textmem)<BR> y=y-sc<BR> d=not d<BR> end repeat<BR> <BR> <A HREF="graphs.html#drawline">drawline</A>(im,point(0, y0), point(w, y0), bord) -- x-axis<BR> -- add arrow to right<BR> <A HREF="graphs.html#drawline">drawline</A>(im, point(w, y0), point(w-7, y0+5), bord)<BR> <A HREF="graphs.html#drawline">drawline</A>(im, point(w, y0), point(w-7, y0-5), bord)<BR> -- add label<BR> <A HREF="graphs.html#drawtext">drawtext</A>(im, "x", point(w+6,y0), bord, textmem)<BR> -- add scale<BR> -- calculate sensible increments<BR> mx=max(rightX,abs(leftX))<BR> lg=log(mx)/log(10)<BR> if integer(lg)&#062;lg then p=integer(lg)-1<BR> else p=integer(lg)<BR> n=mx/power(10,p)<BR> sc=power(10,p)<BR> if n&#060;6 then<BR> p=p-1<BR> sc=sc/2<BR> n=n*2<BR> end if<BR> -- choose whether to alternate text labels<BR> if n&#062;4 then al=0<BR> else al=1<BR> -- write labels with sensible float precision<BR> the floatprecision=min(0,p)<BR> <BR> -- draw scale to right of origin<BR> x=sc<BR> d=0<BR> repeat while x&#060;=rightX<BR> <A HREF="graphs.html#drawline">drawline</A>(im, point(x0+x*xScale, y0-3), point(x0+x*xScale, y0), bord)<BR> if d or al then <A HREF="graphs.html#drawtext">drawtext</A>(im, string(x), point(x0+x*xScale, y0-10), bord, textmem)<BR> x=x+sc<BR> d=not d<BR> end repeat<BR> -- draw scale to left of origin<BR> x=-sc<BR> d=0<BR> repeat while x&#062;=leftX<BR> <A HREF="graphs.html#drawline">drawline</A>(im, point(x0+x*xScale, y0-3), point(x0+x*xScale, y0), bord)<BR> if d or al then <A HREF="graphs.html#drawtext">drawtext</A>(im, string(x), point(x0+x*xScale, y0-10), bord, textmem)<BR> x=x-sc<BR> d=not d<BR> end repeat<BR> end if<BR> <BR> -- draw the functions<BR> currentPoint = 0<BR> lastpoint=0<BR> g=1<BR> cl=col&#091;1&#093;<BR> repeat with i = 1 to xValues.count<BR> x = xValues&#091;i&#093;<BR> y = yValues&#091;i&#093;<BR> if y = "undefined" then <BR> currentPoint = 0<BR> else if x="stop" then<BR> currentPoint = 0<BR> -- label the function<BR> if labels then<BR> if lastpoint&#060;&#062;0 then<BR> lab=<A HREF="graphs.html#getlabel">getlabel</A>(functionsToDraw&#091;g&#093;)<BR> <A HREF="graphs.html#drawtext">drawtext</A>(im, lab, lastpoint+point(-10,5), bord, textmem, cl)<BR> end if<BR> end if<BR> <BR> lastPoint=0<BR> g=g+1<BR> if g&#060;=col.count then cl=col&#091;g&#093;<BR> <BR> else<BR> <BR> thisPoint = point((x - leftX)* xScale, (y-bottomY) * yScale)<BR> if currentPoint = 0 then<BR> <A HREF="graphs.html#plotpoint">plotpoint</A>(im, thisPoint, bord, cl)<BR> else<BR> <A HREF="graphs.html#drawline">drawline</A>(im, currentPoint, thisPoint, bord, cl)<BR> end if<BR> currentPoint = thisPoint<BR> lastpoint=thisPoint<BR> end if<BR> end repeat<BR> <BR> <BR> if newgraph then m=new(#bitmap)<BR> else m=l.member<BR> m.image=im<BR> <BR> erase textmem<BR> <BR> return &#091;#member:m,#graph:im,#leftx:leftx,#rightx:rightx,#topy:topy,#bottomy:bottomy&#093;<BR>end<BR><HR><A NAME="getlabel"> </A>on getlabel (function)<BR> --! ARGUMENTS: function (a string or handler name symbol)<BR> --! RETURNS: the function as a string <BR> --! if the function is a symbol such as #func then there must be an equivalent handler #funclabel<BR> if symbolp(function) then <BR> function=value(function&"label()")<BR> end if<BR> return "y="&function<BR>end<BR><HR><A NAME="plotpoint"> </A>on plotpoint im, pt, b, col<BR> --! ARGUMENTS: im (an image object), pt (a point), b (a number), col (a color object)<BR> --! RETURNS: nothing<BR> --! Plots the point pt in the image, using b as a border. <BR> --! Reverses the y-direction of the point, so the point is measured upwards. <BR> if voidp(col) then col=rgb(0,0,0)<BR> p=point(pt&#091;1&#093;+b,im.height-pt&#091;2&#093;-b)<BR> im.setpixel(p,col)<BR>end<BR><HR><A NAME="drawline"> </A>on drawline im, pt1, pt2, b, col<BR> --! ARGUMENTS: im (an image object), pt1, pt2 (points), b (a number), col (a color object)<BR> --! RETURNS: nothing<BR> --! Draws a line from pt1 to pt2 in the image, using b as a border. <BR> --! Reverses the y-direction of the point, so the point is measured upwards. <BR> if voidp(col) then col=rgb(0,0,0)<BR> p1=point(pt1&#091;1&#093;+b,im.height-pt1&#091;2&#093;-b)<BR> p2=point(pt2&#091;1&#093;+b,im.height-pt2&#091;2&#093;-b)<BR> im.draw(p1,p2,col)<BR>end<BR><HR><A NAME="drawtext"> </A>on drawtext im, tx, pt, b, mem, col<BR> --! ARGUMENTS: im (an image object), tx (a string), pt (a point), b (a number), mem (a text member), col (a color object)<BR> --! RETURNS: nothing<BR> --! Draws the string tx in the image centered on the point pt, using b as a border. Uses mem as a template for font etc<BR> --! Reverses the y-direction of the point, so the point is measured upwards. <BR> if voidp(col) then col=rgb(0,0,0)<BR> if tx.char&#091;tx.length&#093;="." then delete tx.char&#091;tx.length&#093;<BR> mem.text=tx<BR> mem.color=col<BR> i=mem.image<BR> p=point(pt&#091;1&#093;+b,im.height-pt&#091;2&#093;-b)<BR> im.copypixels(i,i.rect+rect(p,p)-\<BR>rect(i.width/2,i.height/2,i.width/2,i.height/2),i.rect)<BR>end<BR><HR><A NAME="lowest"> </A>on lowest l<BR> --! ARGUMENTS: l (a list)<BR> --! RETURNS: the smallest number in l, ignoring non-numbers<BR> mn="undefined"<BR> repeat with k in l<BR> if integerp(k) or floatp(k) then <BR> if mn="undefined" then mn=k<BR> else mn=min(k,mn)<BR> end if<BR> end repeat<BR> return mn<BR>end<BR><HR><A NAME="highest"> </A>on highest l<BR> --! ARGUMENTS: l (a list)<BR> --! RETURNS: the largest number in l, ignoring non-numbers<BR> mn="undefined"<BR> repeat with k in l<BR> if integerp(k) or floatp(k) then <BR> if mn="undefined" then mn=k<BR> else mn=max(k,mn)<BR> end if<BR> end repeat<BR> return mn<BR>end<BR><HR></KBD><P><A HREF="math index.html">Back to index</A></PRE></BODY></HTML> 